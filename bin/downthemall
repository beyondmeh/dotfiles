#!/bin/sh

JOBS=3
CURL_ARGS="--progress-bar -g -L -O -C -"
ARIA2_ARGS="--summary-interval=0 --file-allocation=none --console-log-level=error --auto-file-renaming=false -c -j 3 -x 3 -s 3 -k 1M"
YOUTUBEDL_ARGS="--no-playlist --no-warnings -c --"

if [ "$1" == "-h" ]; then
cat <<HELP
Download a list of video URLs simultaneously with youtube-dl

Usage: $(basename "$0") [-h] [FILE]


https://github.com/keithieopia/bin/

Copyright (c) 2018-2019 Timothy Keith
Licensed under the MIT license.
HELP
fi

if type aria2c >/dev/null; then
	PROG="youtube-dl --external-downloader aria2c --external-downloader-args \"$ARIA2_ARGS\" $YOUTUBEDL_ARGS"
elif type curl >/dev/null; then
	PROG="youtube-dl --external-downloader curl --external-downloader-args \"$CURL_ARGS\" $YOUTUBEDL_ARGS"
else
	PROG="youtube-dl $YOUTUBEDL_ARGS"
fi

if [ -z "$1" ]; then
	if [ -f "./download.txt" ]; then
		LIST="download.txt"
	else
		echo "ERROR: No input provided."
		echo "	Set the -f flag or create a download.txt in the current directory"
		echo "	with the URLs you wish to download!"
		exit 1
	fi
else
	if [ -f "$1" ]; then
		LIST="$1"
	else
		echo "ERROR: invalid download list given"
		echo "	Set the -f flag or create a download.txt in the current directory"
		echo "	with the URLs you wish to download!"
		exit 1
	fi
fi

# Remove blank lines
cat $LIST | tr -s '\n' '\n' > list.tmp
mv list.tmp $LIST

# unique joblog file for each download.txt 
JOBLOG="/tmp/$(basename $0).$(openssl dgst -md5 $LIST | tail -c 7)"

parallel --will-cite -j $JOBS --joblog $JOBLOG --bar -a $LIST $PROG "{}"
