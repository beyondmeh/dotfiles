#!/bin/bash

usage () {
cat <<HELP 
Securely erase files, directories, and slack space

usage: $(basename "$0") OPTION or FILE
   backup   : Clean temporary and backup files
   bash     : Erase BASH history
   browsers : Runs 'firefox' and 'chromium' options
   crap     : Runs 'backup', 'bash', 'browsers', 'flash', 'thumbs', 'trash'
   dir      : Erases all the files in the current directory
   firefox  : Cleans Firefox cache
   flash    : Cleans Adobe Flash cache
   slack    : Clean file system slack space
   thumbs   : Cleans thumbnails generated by the file manager
   trash    : Clean out trash bin
   *        : Tries to erase a given file  
   

https://github.com/keithieopia/bin/
    
Copyright (c) 2016 Timothy Keith
Licensed under the BSD 2-clause license.
HELP
}

colorize () {
    TITLE="0;97"
    ERROR="0;31"
    SUCCESS="0;32"
    ESC="\033["

    COLOR=\$${1:-NORMAL}
        
    echo -ne "${ESC}`eval echo ${COLOR}`m"
    cat
    echo -ne "${ESC}0m"
}

have() { type "$1" &> /dev/null; }
have dcfldd && DISKDESTROYER='dcfldd' || DISKDESTROYER='dd'
have shred && SHREDDER='shred -fuzv -n 1' || {
    echo "$0 requires 'shred' to be installed!" | colorize ERROR
    exit 1
}

if [ -z ${HISTFILE} ]; then
    HISTFILE="$HOME/.bash_history"
fi


case "${1,,}"
in
    "backup")
        echo "Cleaning Backup Files..." | colorize TITLE
        find . -type f -name '*.bak' -exec $SHREDDER "{}" \;
        find . -type f -name '*~' -exec $SHREDDER "{}" \;
        find . -type f -name '.*~' -exec $SHREDDER "{}" \;
        ;;
        
    "bash")
        echo "Shredding bash history..." | colorize TITLE
        $SHREDDER "${HISTFILE}"
        history -c
        ;;
        
    "browser"|"browsers")
        $0 "chromium"
        $0 "firefox"
        ;;

    "chromium")
        echo "Removing Chromium cache..." | colorize TITLE
        find "$HOME/.cache/chromium" -type f -name '*' -exec $SHREDDER "{}" \;
        ;;
        
    "crap")
        if [ -d "$HOME/.cache/chromium" ]; then
            $0 "chromium"
        fi

        if [ -d "$HOME/.cache/mozilla/firefox" ]; then
            $0 "firefox"
        fi
        
        if [ -d "$HOME/.adobe" ] || [ -d "$HOME/.macromedia" ]; then
            $0 "flash"
        fi

        if [ -f "$HOME/.local/share/recently-used.xbel" ]; then
            echo "Cleaning GNOME's recently used list..." | colorize TITLE
            $SHREDDER "$HOME/.local/share/recently-used.xbel"
        fi

        $0 "thumbs"
        $0 "trash"
        $0 "history"

        echo "Crap successfully removed!" | colorize SUCCESS
        ;;
    
    "dir")
        echo "Shredding entire directory..." | colorize TITLE
        find . -type f -exec $SHREDDER "{}" \;
        ;;
        
    "firefox")
        echo "Removing Firefox cache..." | colorize TITLE
        find "$HOME/.cache/mozilla/firefox" -type f -name "*" -exec $SHREDDER "{}" \;
        ;;
        
    "flash")
        echo "Removing Flash Player cache..." | colorize TITLE
        
        if [ -d "$HOME/.adobe" ]; then
            find "$HOME/.adobe" -type f -name "*" -exec $SHREDDER "{}" \;
        fi
        
        if [ -d "$HOME/.macromedia" ]; then
            find "$HOME/.macromedia" -type f -name "*" -exec $SHREDDER "{}" \;
        fi
        ;;
        
    "slack") 
        if [ "$(id -u)" != "0" ]; then
            if [ -z "$SUDO_COMMAND" ]; then
                echo -e "\e[33mThis script must be run as root, recalling self with sudo...\e[39m"
                sudo $0 $*
                exit 0
            else
                echo -e "\e[31mThis script must be run as root\e[39m"
                exit 1
            fi
        fi
        
        echo 'Shredding slack space...' | colorize TITLE
        $DISKDESTROYER if=/dev/urandom of=.fill bs=4092
        
        echo 'Shredding complete, removing slack file...' | colorize TITLE
        
        sync
        rm .fill
        sync
        
        echo 'Slack space successfully shredded!' | colorize SUCCESS
        ;;
    
    "thumbs")
        echo "Cleaning Thumbnails..." | colorize TITLE
        find "$HOME/.thumbnails" -type f -name '*' -exec $SHREDDER "{}" \;
        ;;
        
    "trash")
        echo "Cleaning Trash..." | colorize TITLE
        find "$HOME/.local/share/Trash" -type f -name "*" -exec $SHREDDER "{}" \;
        ;;
    "-h")
        usage
        exit
        ;;
    *)
        if [ -f $1 ]; then
            echo "Shredding file..." | colorize TITLE
            $SHREDDER $1
        else
            echo "No such command or file!" | colorize ERROR
            exit 1
        fi
        ;;
esac
